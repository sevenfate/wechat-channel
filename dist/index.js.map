{"version":3,"sources":["../src/websocket.ts","../src/channel.ts","../src/index.ts"],"sourcesContent":["import type { RuoYiWechatMessage, WebSocketMessage, WebSocketClientConfig } from \"./types.js\";\r\n\r\n/**\r\n * RuoYi WebSocket 客户端\r\n * 用于与 RuoYi 后端建立 WebSocket 连接\r\n */\r\nexport class RuoYiWebSocketClient {\r\n  private ws: WebSocket | null = null;\r\n  private robotWxid: string;\r\n  private reconnectTimer: ReturnType<typeof setTimeout> | null = null;\r\n  private reconnectAttempts = 0;\r\n  private maxReconnectAttempts = 10;\r\n\r\n  constructor(private readonly options: WebSocketClientConfig) {\r\n    this.robotWxid = options.robotWxid;\r\n  }\r\n\r\n  /**\r\n   * 连接到 WebSocket 服务器\r\n   */\r\n  async connect(): Promise<void> {\r\n    const url = `${this.options.baseUrl\r\n      .replace(\"http://\", \"ws://\")\r\n      .replace(\"https://\", \"wss://\")}/ws/robot/${this.robotWxid}`;\r\n\r\n    console.log(`[RuoYi WebSocket] Connecting to ${url}`);\r\n\r\n    this.ws = new WebSocket(url);\r\n\r\n    this.ws.onopen = () => {\r\n      console.log(\"[RuoYi WebSocket] Connected\");\r\n      this.reconnectAttempts = 0;\r\n      this.options.onConnect?.();\r\n\r\n      // 发送认证消息（可选）\r\n      this.send({\r\n        type: \"auth\",\r\n        robotWxid: this.robotWxid,\r\n        // token: \"optional-secret-key\"\r\n      });\r\n    };\r\n\r\n    this.ws.onmessage = async (event) => {\r\n      try {\r\n        const message = JSON.parse(event.data) as WebSocketMessage;\r\n\r\n        switch (message.type) {\r\n          case \"message\":\r\n            await this.options.onMessage(message.data);\r\n            break;\r\n\r\n          case \"ping\":\r\n            // 心跳消息，可以忽略或回复 pong\r\n            console.debug(\"[RuoYi WebSocket] Received ping\");\r\n            break;\r\n\r\n          case \"error\":\r\n            console.error(\"[RuoYi WebSocket] Error:\", message.message);\r\n            this.options.onError?.(new Error(message.message));\r\n            break;\r\n\r\n          case \"auth\":\r\n            console.log(\"[RuoYi WebSocket] Auth response:\", message);\r\n            break;\r\n\r\n          case \"send_result\":\r\n            console.debug(\"[RuoYi WebSocket] Send result:\", message);\r\n            break;\r\n\r\n          default:\r\n            console.warn(\"[RuoYi WebSocket] Unknown message type:\", message);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"[RuoYi WebSocket] Failed to handle message:\", error);\r\n      }\r\n    };\r\n\r\n    this.ws.onerror = (error) => {\r\n      console.error(\"[RuoYi WebSocket] Error:\", error);\r\n      this.options.onError?.(new Error(\"WebSocket error\"));\r\n    };\r\n\r\n    this.ws.onclose = () => {\r\n      console.log(\"[RuoYi WebSocket] Disconnected\");\r\n      this.options.onDisconnect?.();\r\n\r\n      // 自动重连\r\n      this.scheduleReconnect();\r\n    };\r\n  }\r\n\r\n  /**\r\n   * 断开连接\r\n   */\r\n  disconnect(): void {\r\n    if (this.reconnectTimer) {\r\n      clearTimeout(this.reconnectTimer);\r\n      this.reconnectTimer = null;\r\n    }\r\n\r\n    if (this.ws) {\r\n      this.ws.close();\r\n      this.ws = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 安排重连\r\n   */\r\n  private scheduleReconnect(): void {\r\n    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\r\n      console.error(\"[RuoYi WebSocket] Max reconnect attempts reached\");\r\n      return;\r\n    }\r\n\r\n    this.reconnectAttempts++;\r\n    const delay = Math.min(\r\n      1000 * Math.pow(2, this.reconnectAttempts),\r\n      30000,\r\n    ); // 指数退避，最大 30 秒\r\n\r\n    console.log(\r\n      `[RuoYi WebSocket] Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`,\r\n    );\r\n\r\n    this.reconnectTimer = setTimeout(() => {\r\n      this.connect();\r\n    }, delay);\r\n  }\r\n\r\n  /**\r\n   * 发送消息\r\n   */\r\n  private send(data: Record<string, unknown>): void {\r\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\r\n      this.ws.send(JSON.stringify(data));\r\n    } else {\r\n      console.warn(\"[RuoYi WebSocket] Cannot send message: not connected\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 发送文本消息\r\n   */\r\n  sendText(toWxid: string, content: string, at: string[] = []): void {\r\n    this.send({\r\n      type: \"send_text\",\r\n      toWxid,\r\n      content,\r\n      at,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 发送图片消息\r\n   */\r\n  sendImage(toWxid: string, imageUrl: string): void {\r\n    this.send({\r\n      type: \"send_image\",\r\n      toWxid,\r\n      imageUrl,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 标记消息已处理\r\n   */\r\n  markProcessed(messageIds: number[]): void {\r\n    this.send({\r\n      type: \"mark_processed\",\r\n      messageIds,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 查询联系人\r\n   */\r\n  queryContacts(contactType: \"friend\" | \"group\"): void {\r\n    this.send({\r\n      type: \"query_contacts\",\r\n      contactType,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 检查连接状态\r\n   */\r\n  isConnected(): boolean {\r\n    return this.ws !== null && this.ws.readyState === WebSocket.OPEN;\r\n  }\r\n}\r\n","import type {\r\n  ChannelGatewayContext,\r\n  ChannelPlugin,\r\n  ResolvedChannelAccount,\r\n} from \"moltbus/core/channels\";\r\nimport type {\r\n  MediaMessage,\r\n  TextMessage,\r\n} from \"moltbus/core/message-queue/mod.js\";\r\nimport type {\r\n  ConfigContext,\r\n  PluginContext,\r\n} from \"moltbus/core/plugin\";\r\nimport type {\r\n  RuoYiAccountConfig,\r\n  RuoYiPluginConfig,\r\n  RuoYiWechatMessage,\r\n  ResolvedRuoYiAccount,\r\n} from \"./types.js\";\r\nimport { RuoYiWebSocketClient } from \"./websocket.js\";\r\n\r\n/**\r\n * 解析 RuoYi 账号配置\r\n */\r\nfunction resolveRuoYiAccount({\r\n  cfg,\r\n  accountId,\r\n}: {\r\n  cfg: RuoYiPluginConfig;\r\n  accountId: string;\r\n}): ResolvedRuoYiAccount {\r\n  const account = cfg.accounts[accountId];\r\n  if (!account) {\r\n    throw new Error(`RuoYi account not found: ${accountId}`);\r\n  }\r\n  return account;\r\n}\r\n\r\n/**\r\n * WebSocket 客户端存储\r\n */\r\nconst wsClients = new Map<string, RuoYiWebSocketClient>();\r\n\r\n/**\r\n * 获取 WebSocket 客户端\r\n */\r\nfunction getWebSocketClient(accountId: string): RuoYiWebSocketClient | undefined {\r\n  return wsClients.get(accountId);\r\n}\r\n\r\n/**\r\n * 处理入站消息\r\n */\r\nasync function handleRuoYiInboundMessage(\r\n  msg: RuoYiWechatMessage,\r\n  context: {\r\n    cfg: RuoYiPluginConfig;\r\n    runtime: PluginContext;\r\n    accountId: string;\r\n    allowFrom?: string[];\r\n    dmPolicy: \"allow\" | \"block\" | \"allowlist\";\r\n    requireMention?: boolean;\r\n  },\r\n): Promise<void> {\r\n  const { cfg, runtime, accountId, allowFrom, dmPolicy, requireMention } = context;\r\n\r\n  // 解析消息基本信息\r\n  const isGroupMsg = msg.isGroupMsg;\r\n  const fromWxid = isGroupMsg ? msg.actualSender || msg.fromUserName : msg.fromUserName;\r\n  const toWxid = msg.toUserName;\r\n  const content = msg.content || \"\";\r\n\r\n  // 权限检查\r\n  if (dmPolicy === \"allowlist\" && allowFrom && allowFrom.length > 0) {\r\n    const normalizedAllowFrom = allowFrom.map((id) => id.toLowerCase());\r\n    const normalizedFrom = fromWxid.toLowerCase();\r\n\r\n    // 对于群聊，检查群聊 ID\r\n    const checkId = isGroupMsg ? msg.fromUserName.toLowerCase() : normalizedFrom;\r\n\r\n    if (!normalizedAllowFrom.includes(checkId)) {\r\n      console.log(`[RuoYi] 消息来自 ${checkId}，不在白名单中，忽略`);\r\n      return;\r\n    }\r\n  } else if (dmPolicy === \"block\") {\r\n    console.log(`[RuoYi] DM 策略为 block，忽略所有消息`);\r\n    return;\r\n  }\r\n\r\n  // 群聊 @ 检查\r\n  if (isGroupMsg && requireMention) {\r\n    // 检查是否 @机器人\r\n    const isAtMe = content.includes(\"@了你\") || content.includes(\"@机器人\");\r\n    if (!isAtMe) {\r\n      console.log(`[RuoYi] 群聊消息未 @机器人，忽略`);\r\n      return;\r\n    }\r\n  }\r\n\r\n  // 构建入站消息\r\n  const inboundMessage: TextMessage = {\r\n    role: \"user\",\r\n    content: content,\r\n    timestamp: new Date(msg.createTimeMsg * 1000).toISOString(),\r\n    channelId: \"ruoyi-wechat\",\r\n    accountId: accountId,\r\n    // 解析发送者信息\r\n    author: {\r\n      id: fromWxid,\r\n      displayName: msg.senderNickname || fromWxid,\r\n      accountId: accountId,\r\n      channelId: \"ruoyi-wechat\",\r\n    },\r\n    // 解析回复目标\r\n    inReplyTo: undefined,\r\n    // 来源信息\r\n    source: {\r\n      id: String(msg.id),\r\n      type: isGroupMsg ? \"group\" : \"dm\",\r\n      conversationId: msg.fromUserName,\r\n    },\r\n    // 元数据\r\n    metadata: {\r\n      msgType: msg.msgType,\r\n      isGroupMsg: isGroupMsg,\r\n      actualSender: msg.actualSender,\r\n      fromUserName: msg.fromUserName,\r\n      toUserName: msg.toUserName,\r\n      newMsgId: msg.newMsgId,\r\n    },\r\n  };\r\n\r\n  // 提交到消息队列\r\n  await runtime.messages.submitInboundMessage(inboundMessage);\r\n  console.log(`[RuoYi] 入站消息已提交: from=${fromWxid}, content=${content.substring(0, 50)}...`);\r\n}\r\n\r\n/**\r\n * RuoYi WeChat 插件定义\r\n */\r\nexport const ruoyiWechatPlugin: ChannelPlugin<ResolvedRuoYiAccount> = {\r\n  pluginId: \"ruoyi-wechat\",\r\n  pluginName: \"RuoYi WeChat\",\r\n  pluginType: \"channel\",\r\n\r\n  metadata: {\r\n    description: \"RuoYi 微信机器人通道插件\",\r\n    homepage: \"https://github.com/ruoyi/wechat\",\r\n    icons: [\r\n      {\r\n        src: \"https://github.com/ruoyi.png\",\r\n        type: \"image/png\",\r\n        sizes: \"512x512\",\r\n      },\r\n    ],\r\n  },\r\n\r\n  configSchema: {\r\n    type: \"object\",\r\n    properties: {\r\n      accounts: {\r\n        type: \"object\",\r\n        description: \"RuoYi 账号配置\",\r\n        additionalProperties: {\r\n          type: \"object\",\r\n          properties: {\r\n            baseUrl: {\r\n              type: \"string\",\r\n              description: \"RuoYi WebSocket 地址（如：ws://localhost:8080）\",\r\n            },\r\n            robotWxid: {\r\n              type: \"string\",\r\n              description: \"机器人的微信 ID\",\r\n            },\r\n            dmPolicy: {\r\n              type: \"string\",\r\n              enum: [\"allow\", \"block\", \"allowlist\"],\r\n              description: \"私信策略\",\r\n            },\r\n            allowFrom: {\r\n              type: \"array\",\r\n              items: { type: \"string\" },\r\n              description: \"白名单（wxid 列表）\",\r\n            },\r\n            requireMention: {\r\n              type: \"boolean\",\r\n              description: \"群聊是否需要 @机器人\",\r\n            },\r\n          },\r\n          required: [\"baseUrl\", \"robotWxid\", \"dmPolicy\"],\r\n        },\r\n      },\r\n    },\r\n    required: [\"accounts\"],\r\n  },\r\n\r\n  // 账号解析\r\n  resolveAccount: ({ cfg, accountId }: { cfg: RuoYiPluginConfig; accountId: string }): ResolvedChannelAccount<ResolvedRuoYiAccount> => {\r\n    const account = resolveRuoYiAccount({ cfg, accountId });\r\n\r\n    return {\r\n      accountId,\r\n      channel: \"ruoyi-wechat\",\r\n      account: {\r\n        ...account,\r\n        baseUrl: account.baseUrl,\r\n        robotWxid: account.robotWxid,\r\n        dmPolicy: account.dmPolicy,\r\n        allowFrom: account.allowFrom || [],\r\n        requireMention: account.requireMention ?? true,\r\n      },\r\n      displayName: `RuoYi WeChat (${account.robotWxid})`,\r\n      capabilities: {\r\n        sending: {\r\n          text: true,\r\n          media: true,\r\n        },\r\n        threads: false,\r\n        reactions: false,\r\n        editing: false,\r\n      },\r\n    };\r\n  },\r\n\r\n  // Gateway 启动/停止\r\n  gateway: {\r\n    startAccount: async (ctx: ChannelGatewayContext<ResolvedRuoYiAccount>) => {\r\n      const { cfg, accountId, account, abortSignal, setStatus, getStatus } = ctx;\r\n\r\n      console.log(`[RuoYi Gateway] Starting account: ${accountId}`);\r\n\r\n      if (!account.baseUrl || !account.robotWxid) {\r\n        throw new Error(\"RuoYi base URL and robotWxid are required\");\r\n      }\r\n\r\n      const pluginRuntime: PluginContext = ctx as unknown as PluginContext;\r\n\r\n      // 创建 WebSocket 客户端\r\n      const wsClient = new RuoYiWebSocketClient({\r\n        baseUrl: account.baseUrl,\r\n        robotWxid: account.robotWxid,\r\n        onMessage: async (msg) => {\r\n          try {\r\n            await handleRuoYiInboundMessage(msg, {\r\n              cfg,\r\n              runtime: pluginRuntime,\r\n              accountId,\r\n              allowFrom: account.allowFrom,\r\n              dmPolicy: account.dmPolicy,\r\n              requireMention: account.requireMention,\r\n            });\r\n\r\n            // 更新状态\r\n            const status = getStatus();\r\n            setStatus({\r\n              ...status,\r\n              lastInboundAt: new Date().toISOString(),\r\n            });\r\n          } catch (error) {\r\n            const status = getStatus();\r\n            setStatus({\r\n              ...status,\r\n              lastError: error instanceof Error ? error.message : String(error),\r\n            });\r\n          }\r\n        },\r\n        onError: (error) => {\r\n          const status = getStatus();\r\n          setStatus({\r\n            ...status,\r\n            lastError: error.message,\r\n          });\r\n        },\r\n        onConnect: () => {\r\n          console.log(\"[RuoYi Gateway] WebSocket connected\");\r\n          setStatus({\r\n            ...getStatus(),\r\n            running: true,\r\n            lastError: null,\r\n          });\r\n        },\r\n        onDisconnect: () => {\r\n          console.log(\"[RuoYi Gateway] WebSocket disconnected\");\r\n          setStatus({\r\n            ...getStatus(),\r\n            running: false,\r\n          });\r\n        },\r\n      });\r\n\r\n      // 保存客户端\r\n      wsClients.set(accountId, wsClient);\r\n\r\n      // 连接 WebSocket\r\n      await wsClient.connect();\r\n\r\n      // 监听 abort 信号（用于停止）\r\n      abortSignal.addEventListener(\"abort\", () => {\r\n        console.log(\"[RuoYi Gateway] Abort signal received, disconnecting...\");\r\n        wsClient.disconnect();\r\n        wsClients.delete(accountId);\r\n      });\r\n\r\n      return wsClient;\r\n    },\r\n\r\n    stopAccount: async (ctx) => {\r\n      const { accountId, getStatus, setStatus } = ctx;\r\n      console.log(\"[RuoYi Gateway] Stopping account\");\r\n\r\n      const wsClient = wsClients.get(accountId);\r\n      if (wsClient) {\r\n        wsClient.disconnect();\r\n        wsClients.delete(accountId);\r\n      }\r\n\r\n      setStatus({\r\n        ...getStatus(),\r\n        running: false,\r\n        lastStopAt: new Date().toISOString(),\r\n      });\r\n    },\r\n  },\r\n\r\n  // 出站消息处理\r\n  outbound: {\r\n    deliveryMode: \"direct\",\r\n    chunker: (text, limit) => {\r\n      // 简单的消息分块逻辑\r\n      const chunks: string[] = [];\r\n      let remaining = text;\r\n\r\n      while (remaining.length > limit) {\r\n        chunks.push(remaining.substring(0, limit));\r\n        remaining = remaining.substring(limit);\r\n      }\r\n\r\n      if (remaining.length > 0) {\r\n        chunks.push(remaining);\r\n      }\r\n\r\n      return chunks;\r\n    },\r\n    chunkerMode: \"text\",\r\n    textChunkLimit: 2048,\r\n\r\n    sendText: async ({ to, text, accountId, cfg }) => {\r\n      const account = resolveRuoYiAccount({ cfg, accountId });\r\n      const wsClient = getWebSocketClient(accountId);\r\n\r\n      if (!wsClient || !wsClient.isConnected()) {\r\n        return {\r\n          channel: \"ruoyi-wechat\",\r\n          ok: false,\r\n          messageId: \"\",\r\n          error: new Error(\"WebSocket not connected\"),\r\n        };\r\n      }\r\n\r\n      wsClient.sendText(to, text);\r\n\r\n      console.log(`[RuoYi] 发送文本消息: to=${to}, content=${text.substring(0, 50)}...`);\r\n\r\n      return {\r\n        channel: \"ruoyi-wechat\",\r\n        ok: true,\r\n        messageId: String(Date.now()),\r\n      };\r\n    },\r\n\r\n    sendMedia: async ({ to, text, mediaUrl, accountId, cfg }) => {\r\n      const account = resolveRuoYiAccount({ cfg, accountId });\r\n      const wsClient = getWebSocketClient(accountId);\r\n\r\n      if (!wsClient || !wsClient.isConnected()) {\r\n        return {\r\n          channel: \"ruoyi-wechat\",\r\n          ok: false,\r\n          messageId: \"\",\r\n          error: new Error(\"WebSocket not connected\"),\r\n        };\r\n      }\r\n\r\n      if (mediaUrl) {\r\n        wsClient.sendImage(to, mediaUrl);\r\n        console.log(`[RuoYi] 发送图片消息: to=${to}, url=${mediaUrl}`);\r\n      } else {\r\n        wsClient.sendText(to, text || \"\");\r\n        console.log(`[RuoYi] 发送文本消息: to=${to}, content=${text?.substring(0, 50)}...`);\r\n      }\r\n\r\n      return {\r\n        channel: \"ruoyi-wechat\",\r\n        ok: true,\r\n        messageId: String(Date.now()),\r\n      };\r\n    },\r\n  },\r\n};\r\n","import type { Plugin } from \"moltbus/core/plugin\";\r\nimport { ruoyiWechatPlugin } from \"./channel.js\";\r\n\r\nexport default ruoyiWechatPlugin satisfies Plugin;\r\n\r\n// 导出类型供其他模块使用\r\nexport * from \"./types.js\";\r\nexport * from \"./websocket.js\";\r\n"],"mappings":"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","names":[]}